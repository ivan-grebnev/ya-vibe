В прошлом уроке мы научились строить событийную модель, чтобы иметь возможность строить отчеты эффективности использования нашего лендинга. Но что если нам нужно проводить аналитику не только внутри нашей страницы, но и по внешним взаимодействиям?

В этом уроке мы разберём, как настроить приём события из внешнего системы - например, событие оплаты курса пользователем, чтобы потом посчитать конверсию лида в покупку.

Если лендинг собирает лиды, то маркетинговые и другие инструменты вокруг него тоже создают события: клики по рекламе, переходы, подтверждения, статусы. А получить такие события нам позволяет технология под названием webhook.

Webhook - это входящий запрос (HTTP) от внешней системы, в рамках которого нашей системе отправляется определенное событие.

В этом запросе есть:
- заголовок X-Webhook-Secret - ключ безопасности для верификации запроса
- поле event_id - уникальный идентификатор события
- поле event_type - тип события
- поле source - тип события
- поле data - может содержать любую бизнес-информацию, например lead_id, сумму оплаты и тд

Чтобы избежать дублирования записей и не получить из-за этого различные негативные последствия, нам необходимо реализовать метод сохранения событий идемпотентным. То есть мы не должны обрабатывать события, которые уже были сохранены ранее. Поможет нам в этом уникальное поле event_id - если оно уже сохранено в таблице, то мы его не сохраняем повторно.

Научим наш систему принимать и обрабатывать внешние события:
```
Ты senior backend-разработчик.

Необходимо реализовать webhook-контроллер для приема внешних событий оплат в EventLog из сервиса платежей.

Задачи:
- добавить в docker compose в сервис app переменную окружения WEBHOOK_SECRET
- добавить маршрут POST /api/webhook/payment: принимает запросы c заголовком X-Webhook-Secret и если он не равен env WEBHOOK_SECRET - отдает статус 401, сохраняет в EventLog значения полей (id=event_id, type=event_type=, source='payment_service', payload=data, заполняем leadId если заполнено поле data.lead_id) и отдает 200 { "status": "ok" }, если запись id=event_id уже существует отдает статус 200 { "status": "duplicate_ignored" }
- добавить команду для имитации отправки webhook оплаты через curl, где первым параметром указывается lead_id (необязательно, по умолчанию рандом), вторым параметром event_id (необязательно, по умолчанию рандом)
- проверить работоспособность команды и исправить в случае необходимости
- добавить описание запуска команды в README.md через docker compose
- добавить git коммит
- перезапустить окружение
```

Попробуем выполнить команду добавленную в README.md. В EventLog должна появиться запись с событием оплаты.