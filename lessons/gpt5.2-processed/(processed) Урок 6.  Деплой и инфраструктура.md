# Урок 6. Деплой и инфраструктура

Мы подходим к финалу курса по выполнению тестового задания от Яндекс.Практикум. Проект собран, логика работает, интеграции настроены. Остался последний шаг — **запустить всё «вживую» в интернете**.

Чтобы это сделать, нужно пройти несколько этапов:

1. Подготовить проект к публикации
2. Опубликовать репозиторий на GitHub
3. Развернуть проект на VPS
4. Настроить домен через DNS

---

## Подготовка проекта к публикации

Перед публикацией важно привести проект в порядок.

Что нужно проверить и сделать:

* все изменения закоммичены;
* переменные окружения вынесены в `.env`;
* создан файл `.env.example`;
* добавлен скрипт быстрой проверки проекта;
* настроена работа через защищённое соединение HTTPS (nginx + Let’s Encrypt).

На протяжении курса результаты каждого урока фиксировались в git. Это позволяет откатываться к любому этапу и видеть развитие проекта шаг за шагом.

---

## Безопасность переменных окружения

Хранить реальные значения переменных в публичном репозитории небезопасно. Поэтому выносим их в `.env` и исключаем из git.

Задание агенту остаётся без изменений:

```
Вынеси все переменные окружения задаваемые в docker-compose в файл .env, помести его в ".gitignore". 
Создай на примере .env файл .env.example, внутри которого оставь пустыми значения переменных: WEBHOOK_SECRET, TG_TOKEN, TG_CHAT_ID.
Закрой порты сервисов app и db от глобальной сети
Создай git коммит
Перезапусти окружение
```

После выполнения:

* `.env` используется локально,
* `.env.example` показывает структуру,
* сервисы не доступны напрямую извне.

---

## Скрипт демо-запуска

Чтобы упростить проверку проекта, реализуем сценарий быстрого запуска.

Идея такая:

* скачали репозиторий,
* открыли README.md,
* запустили одну команду,
* получили рабочее окружение.

Реализуем через агент:

```
Необходимо реализовать команду демо-запуска проекта - bash-скрипт запуска docker-compose окружения только контейнеров app и db (в detached режиме). У команды есть опция передачи значения TG_TOKEN.

Перед запуском контейнеров .env.example копируется в .env, проставляется demo-значение в переменную WEBHOOK_SECRET

После того как контейнеры запущены и готовы к работе:
- если в команду демо-запуска передавался опционально токен TG_TOKEN тогда получаем TG_CHAT_ID и заполняем переменные в .env
- выполняем команды seed-заполнения таблицы Lead
- проверяем работу событий landing_view, cta_click и lead_created
- проверяем работу webhook все варианты сочетания lead_id и event_id
  
Создай git коммит
```

В результате:

* окружение поднимается одной командой;
* лендинг доступен по `http://localhost:3000`;
* база заполнена тестовыми данными;
* события работают корректно;
* при передаче `TG_TOKEN` приходит уведомление о создании demo-лида
  (важно: бот должен быть запущен и ему должно быть отправлено хотя бы одно сообщение).

---

## Добавляем HTTPS и nginx

Чтобы проект работал в глобальной сети по HTTPS, добавляем nginx с автоматическим выпуском сертификата через Let’s Encrypt.

Задача агенту:

```
Добавь в docker-compose сервис nginx, который необходим для запуска app-приложения в глобальной сети под https-протоколом.

SSL должен предоставляться сервисом letsencrypt, сертификат выпускается при старте контейнера если еще не был выпущен ранее.

Домен задается переменной окружения SITE_HOST в сервисе nginx.

Переменную SITE_HOST нужно добавить в .env.example

ВАЖНО: домен будет 3-го уровня.
```

После этого:

* проект будет доступен по HTTPS;
* сертификат выпустится автоматически;
* домен задаётся через переменную окружения.

---

## Публикация на GitHub

Когда проект готов, публикуем его:

```
git remote add origin git@github.com:ivan-grebnev/ya-vibe.git
git push origin main
```

Теперь репозиторий доступен публично.

---

## Ручной деплой на VPS

Далее разворачиваем проект на сервере:

```
ssh -p 24422 <user>@<host>
mkdir -p /app
cd /app
git clone https://github.com/ivan-grebnev/ya-vibe.git
cp .env.example .env
nano .env # прописываем: WEBHOOK_SECRET, TG_TOKEN, SITE_HOST
docker compose up -d
```

После запуска:

* контейнеры поднимаются;
* nginx выдаёт SSL;
* лендинг становится доступен по домену.

Пример результата:

[https://ya-vibe.greb.pro/](https://ya-vibe.greb.pro/)

---

## Итог

Вы прошли весь путь:

* от структуры лендинга
* до хранения лидов
* от событийной модели
* до webhook
* от Telegram-интеграции
* до полноценного деплоя в интернет

Проект готов к работе в реальной среде.

<проверка знаний>
